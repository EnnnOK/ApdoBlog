# SpringBoot: No buffer space available TIME_OUT过多导致微服务调用失败

最近在把项目上线到正式环境之后，在试运行的时候，偶尔有前端同事说后台返回没有数据的情况和登录失败的情况发生，后端接口反馈给Web前端和安卓端的体验就像是后台服务挂了一样，然后隔了一会（大概几十秒到一分钟）就恢复了，感觉是有人在重启服务器一样。
刚开始反馈的时候没有在意，因为可能是网络原因导致的，后面越来越多的人提到这件事。给人的感觉就像是后台服务/服务器不稳定一样，或是有人在重启更新服务一样，接口会时不时的挂掉几十秒然后恢复。
通过的同事的描述，情况有一下几个特征：
1. 不是稳定复现的，随时有可能出现服务不可用的情况
2. 出现后自动恢复，每次持续时间大概30s左右（具体时间不清楚），每隔一个小时？左右会发生一次。

出现这种情况，给人很明显的感觉是一个资源池用光了，然后没有及时回收，隔了一会回收了之后服务就恢复正常了。也有同事和我一样的感觉，怀疑是数据库连接池用完了，我首先排除了这个，因为我们的服务上线还没几个人用，然后我们的业务是面向企业的，根本没有高并发的情况，不可能出现这样的情况。这个时候我其实就已经想到了这个资源池可能是TCP的网络资源。
我们后台的服务用的是SpringCloud+SpringBoot的微服务，在开发环境和测试环境都长时间运行没有出现过这种情况，唯一有类似的情况是我们去更新重启服务才会有这种情况发生。部署在开发环境之后，其他环境都一样，只是多了一个nginx转发请求到我们的zuul网关（不要问我为什么用了nginx还要用zuul网关，当初用的时候我就说了不要这样搞），所以我第一感觉是nginx转发到zuul出了问题。之前帮其他人看问题的时候，看到过nginx因为内存不够会返回502的信息。我去问前端和安卓端的同事，都说没有留意HTTP状态码是多少，也没有留意是HTTP状态码不是200报错还是我们的服务返回的状态码不是200报错，之后我让同事注意，遇到了之后，尽可能保留HTTP请求信息用于分析。
所以我首先去到了服务器找到nginx错误日志来分析，看到日志里面有报错信息是
```shell
error createFile() XXXX.css  XXX.js 
```

大概意思是把转发请求静态文件时，创建文件放在nginx目录下出问题了。
TODO 确认nginx会自动缓存请求的静态资源文件到自己的目录下？
我以为就是这个问题呢，准备分析的时候，想了下，要是问题的原因是这个的话，那么安卓端调接口不会出现这个问题啊，很奇怪。
之后又有同事给我说，服务之间调用出问题了。SpringBoot消费者调用生产者出问题了，然后进入了熔断器，我们的熔断器没有做其他处理，直接返回了null，他看代码出现这个问题的唯一原因就是这里。而这个问题在之前的开发环境和测试环境之中都没有出现过。
结合到之前的情况，我排除了nginx那边的问题，更加肯定了是微服务调用之间出了问题。SpringBoot微服务之间通过HTTP调用，这个和我之前想的TCP网络资源出了问题应该是一样的。然后又有安卓端同事反馈到说登录的时候，出现问题，这次抓到HTTP Response了，我看了一下返回信息。
```json
{"timestamp":1566374526452,"status":500,"error":"Internal Server Error","exception":"com.netflix.zuul.exception.ZuulException","message":"NUMBEROF_RETRIES_NEXTSERVER_EXCEEDED"}
```
说的是zuul网关转发请求的时候，失败数量超出最大尝试次数了。结合到前面的情况，我已经很确定这个情况的原因就是网络资源被占光了，但是还要更准确地日志确认和去服务器排查。这个时候我已经想到了很有可能是HTTP请求之后留下了大量的TIME_WAIT导致端口不够用了，之前我看别人的博客处理过这样的问题。但是我在思考为什么会出现这样的问题时候，找不到一个合理的解释，因为我们在开发环境和测试环境都没有过。难道是因为长时间没有重启的原因？我们的开发和测试服务器，一般过了三四天就会更新然后重启服务，而正式环境部署后没有重启过。
我让同事去正式环境找日志给我看，他还以为是nginx到zuul网关出问题了，发给我zuul网关的日志。网关的日志很少，所以我大概搜了一下ERROR日志，发现有这样的提示：
```shell
Caused by: java.net.SocketException: No buffer space available (maximum connections reached?): connect
```
虽然没有遇到过，但是看日志提示和之前我的分析，已经很确定了是因为TCP端口资源被沾光了，导致HTTP调用失败，而且很有可能是TIME_WAIT，因为TIME_WAIT状态是处于即将销毁的状态，隔一会就会销毁，就和之前说的资源回收的概念差不多。现在就是要看为什么服务会在正式环境出现大量的TIME_WAIT了，很有可能是代码中的BUG。

然后同时发给我SpringBoot消费者的日志，不出意外，里面也有和网关一样的ERROR日志。
问题知道了，现在要看为什么出现这个问题了。
我让同事给我远程上去的方法，到了服务器打开命令行
```cmd
netstat -ano 
```

出现一大片的TIME_WAIT，果然是这个原因，我又通过端口号找到进程，发现不是我们的服务，而是sqlserver的服务。后面确认这台服务器只有我们公司两个组的项目再用，确认另一组没有用到这个sqlserver，然后我就直接一把梭哈，杀了sqlserver。然后去告诉其他同事，看一下后面会不会出现这个问题了。
隔了一天之后，同事也没有反馈。我又去看了日志，自从杀了sqlserver之后，日志里面再没有出现过之前的问题了。问题应该解决了，也解释了为什么在开发和测试环境没有出现同样的情况。

其实出现这种情况，重启服务器之后是可以解决的，但是不能解决根本问题，因为根本不知道是哪里出现问题了。直接杀了sqlserver之后，我其实有点后悔，应该顺着TIME_WAIT去找端口和进程是什么程序做什么操作导致产生了大量的TIME_WAIT，毕竟连接数据库产生TIME_WAIT可能会出现在其他项目中，应该研究一下学习一下。当时因为上了一天班之后很疲惫了，分析这个也搞得有点烦躁了，只想早点回去吃饭睡觉，就直接杀了然后下班回去吃饭睡觉了。


```java
spring-core 4.3.10
ObjectToObjectConverter line 106
Date d = new Date("Sun Jun 30 12:46:00 CST 2019")
```